generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

model User {
  id            String    @id @default(cuid())
  email         String    @unique
  password      String?
  name          String?
  image         String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  accounts      Account[]
  sessions      Session[]
  teamMembers   TeamMember[]
  createdAssets Asset[]
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Team {
  id          String       @id @default(cuid())
  name        String
  description String?
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
  
  members     TeamMember[]
  projects    Project[]
  trainingDatasets  TrainingDataset[]
  trainingJobs      TrainingJob[]
  trainedModels     TrainedModel[]
}

model TeamMember {
  id        String   @id @default(cuid())
  userId    String
  teamId    String
  role      TeamRole @default(MEMBER)
  createdAt DateTime @default(now())
  
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  team      Team     @relation(fields: [teamId], references: [id], onDelete: Cascade)
  
  @@unique([userId, teamId])
}

enum TeamRole {
  OWNER
  ADMIN
  MEMBER
}

model Project {
  id          String   @id @default(cuid())
  name        String
  description String?
  teamId      String
  
  // Enhanced fields for location-based grouping
  location    String?  // Farm/property name
  purpose     ProjectPurpose @default(WEED_DETECTION)
  season      String?  // e.g., "2024 Spring", "Winter Survey"
  
  // Geographic center for map filtering
  centerLat   Float?
  centerLon   Float?
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  team        Team     @relation(fields: [teamId], references: [id], onDelete: Cascade)
  assets      Asset[]
  jobs        ProcessingJob[]
  orthomosaics Orthomosaic[]
  batchJobs   BatchJob[]
  trainingDatasets TrainingDataset[]

  @@index([teamId])
  @@index([location])
  @@index([purpose, season])
}

enum ProjectPurpose {
  WEED_DETECTION
  CROP_HEALTH
  SOIL_ANALYSIS
  INFRASTRUCTURE
  LIVESTOCK
  ENVIRONMENTAL
}

model Asset {
  id              String   @id @default(cuid())
  projectId       String
  fileName        String
  fileSize        Int
  mimeType        String
  storageUrl      String
  thumbnailUrl    String?
  
  // S3 Storage (nullable for backward compatibility)
  s3Key           String?  // S3 object key
  s3Bucket        String?  // S3 bucket name
  storageType     String   @default("local") // "local" or "s3"
  uploadedAt      DateTime @default(now())
  
  // Flight session grouping
  flightSession   String?  // e.g., "Flight 1 - Section A", "Morning Survey"
  flightDate      DateTime?
  
  // Metadata from EXIF
  metadata        Json?
  gpsLatitude     Float?
  gpsLongitude    Float?
  altitude        Float?
  gimbalRoll      Float?
  gimbalPitch     Float?
  gimbalYaw       Float?
  cameraFov       Float?
  imageWidth      Int?
  imageHeight     Int?
  lrfDistance     Float?
  lrfTargetLat    Float?
  lrfTargetLon    Float?
  
  createdAt       DateTime @default(now())
  createdById     String
  
  project         Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  createdBy       User     @relation(fields: [createdById], references: [id])
  detections      Detection[]
  processingJobs  ProcessingJob[]
  annotationSessions AnnotationSession[]
  pendingAnnotations PendingAnnotation[]

  @@index([projectId])
  @@index([flightSession])
  @@index([gpsLatitude, gpsLongitude])
  @@unique([s3Key])
  @@index([createdById])
  @@index([createdAt])
}

model ProcessingJob {
  id          String       @id @default(cuid())
  projectId   String
  type        JobType
  status      JobStatus    @default(PENDING)
  config      Json?        // Job-specific configuration (e.g., Roboflow model ID)
  progress    Int          @default(0)
  errorMessage String?
  startedAt   DateTime?
  completedAt DateTime?
  createdAt   DateTime     @default(now())
  
  project     Project      @relation(fields: [projectId], references: [id], onDelete: Cascade)
  assets      Asset[]
  detections  Detection[]
  
  @@index([projectId, status])
  @@index([status])
  @@index([createdAt])
}

enum JobType {
  AI_DETECTION
  MANUAL_ANNOTATION
}

enum JobStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  CANCELLED
}

model Detection {
  id              String         @id @default(cuid())
  jobId           String
  assetId         String
  type            DetectionType
  className       String
  confidence      Float?

  // Custom model source tracking
  customModelId   String?
  
  // Pixel coordinates
  boundingBox     Json           // {x, y, width, height} or polygon points
  
  // Geographic coordinates
  geoCoordinates  Json           // GeoJSON format
  centerLat       Float?
  centerLon       Float?
  
  // Additional data
  metadata        Json?          // Any additional data (e.g., chemical recommendations)
  verified        Boolean        @default(false)
  reviewedAt      DateTime?
  reviewedBy      String?
  rejected        Boolean        @default(false)
  userCorrected   Boolean        @default(false)
  originalClass   String?
  
  createdAt       DateTime       @default(now())
  
  job             ProcessingJob  @relation(fields: [jobId], references: [id], onDelete: Cascade)
  asset           Asset          @relation(fields: [assetId], references: [id], onDelete: Cascade)
  customModel     TrainedModel?  @relation(fields: [customModelId], references: [id])
  
  @@index([jobId])
  @@index([assetId])
  @@index([customModelId])
  @@index([centerLat, centerLon])
  @@index([verified])
  @@index([rejected])
  @@index([createdAt])
  @@index([className])
}

enum DetectionType {
  AI
  MANUAL
}

model ChemicalRecommendation {
  id          String   @id @default(cuid())
  species     String   @unique
  chemical    String
  dosagePerHa Float
  notes       String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model AnnotationSession {
  id            String               @id @default(cuid())
  assetId       String
  userId        String?              // Optional - for when auth is enabled
  status        AnnotationStatus     @default(IN_PROGRESS)
  createdAt     DateTime             @default(now())
  completedAt   DateTime?
  updatedAt     DateTime             @updatedAt
  
  asset         Asset                @relation(fields: [assetId], references: [id], onDelete: Cascade)
  annotations   ManualAnnotation[]
  
  @@index([assetId])
  @@index([status])
}

model ManualAnnotation {
  id              String           @id @default(cuid())
  sessionId       String
  weedType        String           // e.g., "Unknown Weed #1", "Suspected Lantana"
  confidence      ConfidenceLevel  @default(LIKELY)

  // Pixel coordinates (polygon vertices)
  coordinates     Json             // [[x1,y1], [x2,y2], ...] in pixels

  // Geographic coordinates (converted from pixels)
  geoCoordinates  Json?            // GeoJSON polygon format
  centerLat       Float?           // Center point for map display
  centerLon       Float?

  // Additional metadata
  notes           String?
  verified        Boolean          @default(false)
  verifiedBy      String?          // User who verified
  verifiedAt      DateTime?

  // Training integration - legacy (single project from env var)
  pushedToTraining Boolean         @default(false)
  pushedAt         DateTime?
  roboflowImageId  String?

  // Training integration - new (project-aware)
  roboflowProjectId   String?      // Which Roboflow project this targets
  roboflowClassName   String?      // Class name as it appears in Roboflow
  trainingSessionId   String?      // Link to training session workflow

  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt

  session         AnnotationSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  trainingSession TrainingSession?  @relation(fields: [trainingSessionId], references: [id])

  @@index([sessionId])
  @@index([weedType])
  @@index([centerLat, centerLon])
  @@index([pushedToTraining])
  @@index([roboflowProjectId])
  @@index([trainingSessionId])
}

enum AnnotationStatus {
  IN_PROGRESS
  COMPLETED
  REVIEWED
  ARCHIVED
}

enum ConfidenceLevel {
  CERTAIN
  LIKELY
  UNCERTAIN
}

model Orthomosaic {
  id            String           @id @default(cuid())
  projectId     String
  name          String
  description   String?
  
  // File information
  originalFile  String           // S3/local path to GeoTIFF
  tilesetPath   String?          // Path to processed tiles
  fileSize      BigInt
  
  // S3 Storage (nullable for backward compatibility)
  s3Key         String?          // S3 object key for GeoTIFF
  s3TilesetKey  String?          // S3 prefix for tiles
  s3Bucket      String?          // S3 bucket name
  storageType   String           @default("local") // "local" or "s3"
  
  // Georeferencing
  bounds        Json             // GeoJSON bounds
  centerLat     Float
  centerLon     Float
  minZoom       Int              @default(10)
  maxZoom       Int              @default(22)
  
  // Metadata
  captureDate   DateTime?
  resolution    Float?           // cm/pixel
  area          Float?           // hectares
  imageCount    Int?             // number of source images
  
  // Processing status
  status        ProcessingStatus @default(PENDING)
  processingLog Json?
  
  // Relations
  project       Project          @relation(fields: [projectId], references: [id], onDelete: Cascade)
  createdAt     DateTime         @default(now())
  updatedAt     DateTime         @updatedAt
  
  @@index([projectId])
  @@index([status])
}

enum ProcessingStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
}

// ============================================
// SAM3 Batch Annotation Models
// ============================================

model BatchJob {
  id              String          @id @default(cuid())
  projectId       String
  weedType        String          // Target weed type for detection
  exemplars       Json            // Stored exemplar boxes [{x1,y1,x2,y2}, ...]
  textPrompt      String?         // Optional text prompt for SAM3

  // Processing status
  status          BatchJobStatus  @default(QUEUED)
  totalImages     Int             // Total images to process
  processedImages Int             @default(0)
  detectionsFound Int             @default(0)
  errorMessage    String?

  // Timestamps
  createdAt       DateTime        @default(now())
  startedAt       DateTime?
  completedAt     DateTime?

  // Relations
  project         Project         @relation(fields: [projectId], references: [id], onDelete: Cascade)
  pendingAnnotations PendingAnnotation[]

  @@index([projectId])
  @@index([status])
}

enum BatchJobStatus {
  QUEUED
  PROCESSING
  COMPLETED
  FAILED
  CANCELLED
}

model PendingAnnotation {
  id            String                  @id @default(cuid())
  batchJobId    String
  assetId       String
  weedType      String
  confidence    Float                   // SAM3 confidence score

  // Coordinates
  polygon       Json                    // [[x,y], ...] pixel coordinates
  bbox          Json                    // [x1, y1, x2, y2] bounding box

  // Geographic (computed from pixel coords)
  geoPolygon    Json?                   // GeoJSON polygon
  centerLat     Float?
  centerLon     Float?

  // Review status
  status        PendingAnnotationStatus @default(PENDING)
  reviewedAt    DateTime?
  reviewedBy    String?
  rejectionReason String?

  createdAt     DateTime                @default(now())

  // Relations
  batchJob      BatchJob                @relation(fields: [batchJobId], references: [id], onDelete: Cascade)
  asset         Asset                   @relation(fields: [assetId], references: [id], onDelete: Cascade)

  @@index([batchJobId])
  @@index([assetId])
  @@index([status])
  @@index([weedType])
}

enum PendingAnnotationStatus {
  PENDING
  ACCEPTED
  REJECTED
}

// ============================================
// Roboflow Training Integration Models
// ============================================

model RoboflowProject {
  id            String   @id @default(cuid())
  roboflowId    String   @unique  // Roboflow project ID e.g., "lantana-detection-v3"
  workspaceId   String              // Roboflow workspace name
  name          String              // Display name
  type          String              // "object-detection" or "instance-segmentation"
  annotation    String?             // Annotation group name

  // Cached stats (refreshed on sync)
  imageCount    Int      @default(0)
  lastSyncedAt  DateTime @default(now())

  // Relations
  classes           RoboflowClass[]
  trainingSessions  TrainingSession[]

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@index([roboflowId])
  @@index([workspaceId])
}

model RoboflowClass {
  id        String   @id @default(cuid())
  projectId String
  className String
  color     String?  // For UI display consistency
  count     Int      @default(0)  // Number of images with this class

  project   RoboflowProject @relation(fields: [projectId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([projectId, className])
  @@index([projectId])
  @@index([className])
}

model TrainingSession {
  id                    String                 @id @default(cuid())
  roboflowProjectId     String
  workflowType          TrainingWorkflowType
  status                TrainingSessionStatus  @default(IN_PROGRESS)

  // Stats
  imagesTotal           Int      @default(0)
  imagesLabeled         Int      @default(0)
  annotationsCreated    Int      @default(0)
  annotationsPushed     Int      @default(0)

  // Relations
  roboflowProject       RoboflowProject @relation(fields: [roboflowProjectId], references: [id])
  annotations           ManualAnnotation[]

  createdAt             DateTime @default(now())
  completedAt           DateTime?
  pushedAt              DateTime?

  @@index([roboflowProjectId])
  @@index([status])
}

enum TrainingWorkflowType {
  NEW_SPECIES
  IMPROVE_EXISTING
}

enum TrainingSessionStatus {
  IN_PROGRESS
  READY_TO_PUSH
  PUSHING
  COMPLETED
  FAILED
}

// ============================================
// YOLO Training Pipeline Models
// ============================================

model TrainingDataset {
  id                  String   @id @default(cuid())
  name                String
  description         String?

  // S3 location
  s3Path              String
  s3Bucket            String

  // Source project (optional - can be built from multiple sessions)
  projectId           String?
  project             Project? @relation(fields: [projectId], references: [id])

  // Dataset statistics
  imageCount          Int
  labelCount          Int
  classes             String   // JSON: ["wattle", "lantana", ...]

  // Train/val/test split
  trainCount          Int
  valCount            Int
  testCount           Int

  // Augmentation settings applied
  augmentationPreset  String?
  augmentationConfig  String?  // JSON
  augmentedImageCount Int?

  // Relations
  trainingJobs        TrainingJob[]

  // Ownership
  teamId              String
  team                Team     @relation(fields: [teamId], references: [id])
  createdById         String?

  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  @@index([teamId])
  @@index([projectId])
}

model TrainingJob {
  id                  String          @id @default(cuid())

  // What we're training
  datasetId           String
  dataset             TrainingDataset @relation(fields: [datasetId], references: [id])

  // Training configuration
  baseModel           String
  epochs              Int             @default(100)
  batchSize           Int             @default(16)
  imageSize           Int             @default(640)
  learningRate        Float           @default(0.01)

  // Advanced config (optional)
  trainingConfig      String?         // JSON

  // Status tracking
  status              TrainingStatus  @default(QUEUED)
  currentEpoch        Int             @default(0)
  progress            Float           @default(0)

  // Reference to EC2 job
  ec2JobId            String?

  // Metrics - updated during training
  currentMetrics      String?         // JSON
  metricsHistory      String?         // JSON

  // Final metrics (populated on completion)
  finalMAP50          Float?
  finalMAP5095        Float?
  finalPrecision      Float?
  finalRecall         Float?
  finalF1             Float?

  // Timing
  startedAt           DateTime?
  completedAt         DateTime?
  estimatedMinutes    Int?

  // Error handling
  errorMessage        String?
  errorDetails        String?         // JSON

  // Output model (created on successful completion)
  trainedModelId      String?         @unique
  trainedModel        TrainedModel?   @relation(fields: [trainedModelId], references: [id])

  // Ownership
  teamId              String
  team                Team            @relation(fields: [teamId], references: [id])
  createdById         String?

  createdAt           DateTime        @default(now())
  updatedAt           DateTime        @updatedAt

  @@index([teamId])
  @@index([status])
  @@index([datasetId])
}

model TrainedModel {
  id                  String       @id @default(cuid())

  // Naming
  name                String
  version             Int
  displayName         String?
  description         String?

  // S3 storage
  s3Path              String
  s3Bucket            String
  weightsFile         String       @default("best.pt")
  fileSizeBytes       Int?

  // What this model detects
  classes             String       // JSON
  classCount          Int

  // Performance metrics
  mAP50               Float?
  mAP5095             Float?
  precision           Float?
  recall              Float?
  f1Score             Float?

  // Per-class metrics
  classMetrics        String?      // JSON

  // Training lineage
  trainingJob         TrainingJob?
  baseModel           String
  trainedOnImages     Int?
  trainedEpochs       Int?

  // Detection lineage
  detections          Detection[]

  // Status
  status              ModelStatus  @default(READY)
  isActive            Boolean      @default(false)

  // Usage tracking
  inferenceCount      Int          @default(0)
  lastUsedAt          DateTime?

  // Ownership
  teamId              String
  team                Team         @relation(fields: [teamId], references: [id])
  createdById         String?

  createdAt           DateTime     @default(now())
  updatedAt           DateTime     @updatedAt

  @@unique([name, version, teamId])
  @@index([teamId])
  @@index([status])
  @@index([isActive])
}

enum TrainingStatus {
  QUEUED
  PREPARING
  RUNNING
  UPLOADING
  COMPLETED
  FAILED
  CANCELLED
}

enum ModelStatus {
  TRAINING
  READY
  ACTIVE
  ARCHIVED
  FAILED
}

// ============================================
// Audit Trail for Data Modifications
// ============================================

model AuditLog {
  id          String      @id @default(cuid())

  // Action details
  action      AuditAction
  entityType  String      // e.g., "Detection", "ManualAnnotation", "Project"
  entityId    String      // ID of the affected entity

  // State tracking (JSON blobs for flexibility)
  beforeState Json?       // State before modification
  afterState  Json?       // State after modification

  // Actor information
  userId      String?     // Who performed the action (null for system actions)
  userEmail   String?     // Cached for when user is deleted
  ipAddress   String?     // Request origin
  userAgent   String?     // Browser/client info

  // Request context
  requestId   String?     // Correlation ID for tracing

  // Timestamps
  createdAt   DateTime    @default(now())

  // Indexes for efficient querying
  @@index([userId])
  @@index([entityType, entityId])
  @@index([action])
  @@index([createdAt])
}

enum AuditAction {
  CREATE
  UPDATE
  DELETE
  VERIFY
  UNVERIFY
  REJECT
  PUSH_TO_TRAINING
}
