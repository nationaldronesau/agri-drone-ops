generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

model User {
  id        String   @id @default(cuid())
  email     String   @unique
  password  String?
  name      String?
  image     String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  accounts               Account[]
  sessions               Session[]
  teamMembers            TeamMember[]
  createdAssets          Asset[]
  createdReviewSessions  ReviewSession[]    @relation("ReviewSessionCreator")
  assignedReviewSessions ReviewSession[]    @relation("ReviewSessionAssignee")
  yoloInferenceJobs      YOLOInferenceJob[]
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Team {
  id          String   @id @default(cuid())
  name        String
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  members           TeamMember[]
  projects          Project[]
  cameraProfiles    CameraProfile[]
  trainingDatasets  TrainingDataset[]
  trainingJobs      TrainingJob[]
  trainedModels     TrainedModel[]
  reviewSessions    ReviewSession[]
  yoloInferenceJobs YOLOInferenceJob[]
}

model TeamMember {
  id        String   @id @default(cuid())
  userId    String
  teamId    String
  role      TeamRole @default(MEMBER)
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  team Team @relation(fields: [teamId], references: [id], onDelete: Cascade)

  @@unique([userId, teamId])
}

enum TeamRole {
  OWNER
  ADMIN
  MEMBER
}

model Project {
  id              String  @id @default(cuid())
  name            String
  description     String?
  teamId          String
  cameraProfileId String?

  // Enhanced fields for location-based grouping
  location String? // Farm/property name
  purpose  ProjectPurpose @default(WEED_DETECTION)
  season   String? // e.g., "2024 Spring", "Winter Survey"

  // Geographic center for map filtering
  centerLat Float?
  centerLon Float?

  // YOLO inference settings
  activeModelId        String?
  activeModel          TrainedModel? @relation("ProjectActiveModel", fields: [activeModelId], references: [id])
  autoInferenceEnabled Boolean       @default(false)
  features             Json?
  inferenceBackend     InferenceBackend @default(AUTO)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  team              Team               @relation(fields: [teamId], references: [id], onDelete: Cascade)
  cameraProfile     CameraProfile?     @relation(fields: [cameraProfileId], references: [id])
  assets            Asset[]
  jobs              ProcessingJob[]
  orthomosaics      Orthomosaic[]
  batchJobs         BatchJob[]
  trainingDatasets  TrainingDataset[]
  reviewSessions    ReviewSession[]
  yoloInferenceJobs YOLOInferenceJob[]

  @@index([teamId])
  @@index([location])
  @@index([purpose, season])
  @@index([activeModelId])
  @@index([cameraProfileId])
}

enum ProjectPurpose {
  WEED_DETECTION
  CROP_HEALTH
  SOIL_ANALYSIS
  INFRASTRUCTURE
  LIVESTOCK
  ENVIRONMENTAL
}

enum InferenceBackend {
  LOCAL
  ROBOFLOW
  AUTO
}

model Asset {
  id              String  @id @default(cuid())
  projectId       String
  fileName        String
  fileSize        Int
  mimeType        String
  storageUrl      String
  thumbnailUrl    String?
  cameraProfileId String?

  // S3 Storage (nullable for backward compatibility)
  s3Key       String? // S3 object key
  s3Bucket    String? // S3 bucket name
  storageType String   @default("local") // "local" or "s3"
  uploadedAt  DateTime @default(now())

  // Flight session grouping
  flightSession String? // e.g., "Flight 1 - Section A", "Morning Survey"
  flightDate    DateTime?

  // Metadata from EXIF
  metadata     Json?
  gpsLatitude  Float?
  gpsLongitude Float?
  altitude     Float?
  gimbalRoll   Float?
  gimbalPitch  Float?
  gimbalYaw    Float?
  cameraFov    Float?
  imageWidth   Int?
  imageHeight  Int?
  lrfDistance  Float?
  lrfTargetLat Float?
  lrfTargetLon Float?

  createdAt   DateTime @default(now())
  createdById String

  project            Project             @relation(fields: [projectId], references: [id], onDelete: Cascade)
  cameraProfile      CameraProfile?      @relation(fields: [cameraProfileId], references: [id])
  createdBy          User                @relation(fields: [createdById], references: [id])
  detections         Detection[]
  processingJobs     ProcessingJob[]
  annotationSessions AnnotationSession[]
  pendingAnnotations PendingAnnotation[]
  trainingDatasets   TrainingDatasetAsset[]

  @@unique([s3Key])
  @@index([projectId])
  @@index([cameraProfileId])
  @@index([flightSession])
  @@index([gpsLatitude, gpsLongitude])
  @@index([createdById])
  @@index([createdAt])
}

model ProcessingJob {
  id           String    @id @default(cuid())
  projectId    String
  type         JobType
  status       JobStatus @default(PENDING)
  config       Json? // Job-specific configuration (e.g., Roboflow model ID)
  progress     Int       @default(0)
  errorMessage String?
  startedAt    DateTime?
  completedAt  DateTime?
  createdAt    DateTime  @default(now())

  project    Project     @relation(fields: [projectId], references: [id], onDelete: Cascade)
  assets     Asset[]
  detections Detection[]

  @@index([projectId, status])
  @@index([status])
  @@index([createdAt])
}

enum JobType {
  AI_DETECTION
  MANUAL_ANNOTATION
}

enum JobStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  CANCELLED
}

model Detection {
  id         String        @id @default(cuid())
  jobId      String?
  assetId    String
  type       DetectionType
  className  String
  confidence Float?

  // Custom model source tracking
  customModelId String?

  // Pixel coordinates
  boundingBox Json // {x, y, width, height} or polygon points

  // Geographic coordinates
  geoCoordinates  Json? // GeoJSON format
  centerLat       Float?
  centerLon       Float?
  geoDsmCorrected Boolean @default(false)

  // YOLO preprocessing metadata (letterbox/tiling)
  preprocessingMeta Json?

  // YOLO inference linkage (local model)
  inferenceJobId String?

  // Additional data
  metadata      Json? // Any additional data (e.g., chemical recommendations)
  verified      Boolean   @default(false)
  reviewedAt    DateTime?
  reviewedBy    String?
  rejected      Boolean   @default(false)
  userCorrected Boolean   @default(false)
  originalClass String?

  createdAt DateTime @default(now())

  job          ProcessingJob?    @relation(fields: [jobId], references: [id], onDelete: Cascade)
  asset        Asset             @relation(fields: [assetId], references: [id], onDelete: Cascade)
  customModel  TrainedModel?     @relation(fields: [customModelId], references: [id])
  inferenceJob YOLOInferenceJob? @relation(fields: [inferenceJobId], references: [id], onDelete: SetNull)

  @@index([jobId])
  @@index([assetId])
  @@index([customModelId])
  @@index([inferenceJobId])
  @@index([centerLat, centerLon])
  @@index([verified])
  @@index([rejected])
  @@index([createdAt])
  @@index([className])
}

enum DetectionType {
  AI
  MANUAL
  YOLO_LOCAL
}

model ChemicalRecommendation {
  id          String   @id @default(cuid())
  species     String   @unique
  chemical    String
  dosagePerHa Float
  notes       String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model AnnotationSession {
  id          String           @id @default(cuid())
  assetId     String
  userId      String? // Optional - for when auth is enabled
  status      AnnotationStatus @default(IN_PROGRESS)
  createdAt   DateTime         @default(now())
  completedAt DateTime?
  updatedAt   DateTime         @updatedAt

  asset       Asset              @relation(fields: [assetId], references: [id], onDelete: Cascade)
  annotations ManualAnnotation[]

  @@index([assetId])
  @@index([status])
}

model ManualAnnotation {
  id         String          @id @default(cuid())
  sessionId  String
  weedType   String // e.g., "Unknown Weed #1", "Suspected Lantana"
  confidence ConfidenceLevel @default(LIKELY)

  // Pixel coordinates (polygon vertices)
  coordinates Json // [[x1,y1], [x2,y2], ...] in pixels

  // Geographic coordinates (converted from pixels)
  geoCoordinates Json? // GeoJSON polygon format
  centerLat      Float? // Center point for map display
  centerLon      Float?

  // Additional metadata
  notes      String?
  verified   Boolean   @default(false)
  verifiedBy String? // User who verified
  verifiedAt DateTime?

  // Training integration - legacy (single project from env var)
  pushedToTraining Boolean   @default(false)
  pushedAt         DateTime?
  roboflowImageId  String?

  // Training integration - new (project-aware)
  roboflowProjectId String? // Which Roboflow project this targets
  roboflowClassName String? // Class name as it appears in Roboflow
  trainingSessionId String? // Link to training session workflow

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  session         AnnotationSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  trainingSession TrainingSession?  @relation(fields: [trainingSessionId], references: [id])

  @@index([sessionId])
  @@index([weedType])
  @@index([centerLat, centerLon])
  @@index([pushedToTraining])
  @@index([roboflowProjectId])
  @@index([trainingSessionId])
}

enum AnnotationStatus {
  IN_PROGRESS
  COMPLETED
  REVIEWED
  ARCHIVED
}

enum ConfidenceLevel {
  CERTAIN
  LIKELY
  UNCERTAIN
}

model Orthomosaic {
  id          String  @id @default(cuid())
  projectId   String
  name        String
  description String?

  // File information
  originalFile String // S3/local path to GeoTIFF
  tilesetPath  String? // Path to processed tiles
  fileSize     BigInt

  // S3 Storage (nullable for backward compatibility)
  s3Key        String? // S3 object key for GeoTIFF
  s3TilesetKey String? // S3 prefix for tiles
  s3Bucket     String? // S3 bucket name
  storageType  String  @default("local") // "local" or "s3"

  // Georeferencing
  bounds    Json // GeoJSON bounds
  centerLat Float
  centerLon Float
  minZoom   Int   @default(10)
  maxZoom   Int   @default(22)

  // Metadata
  captureDate DateTime?
  resolution  Float? // cm/pixel
  area        Float? // hectares
  imageCount  Int? // number of source images

  // Processing status
  status        ProcessingStatus @default(PENDING)
  processingLog Json?

  // Relations
  project   Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([projectId])
  @@index([status])
}

enum ProcessingStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
}

// ============================================
// SAM3 Batch Annotation Models
// ============================================

model BatchJob {
  id                   String  @id @default(cuid())
  projectId            String
  weedType             String // Target weed type for detection
  exemplars            Json // Stored exemplar boxes [{x1,y1,x2,y2}, ...]
  textPrompt           String? // Optional text prompt for SAM3
  exemplarSourceWidth  Int? // Width of image where exemplars were drawn
  exemplarSourceHeight Int? // Height of image where exemplars were drawn
  exemplarId           String? // Concept propagation exemplar ID
  sourceAssetId        String? // Asset ID used to create exemplar

  // Processing status
  status          BatchJobStatus @default(QUEUED)
  totalImages     Int // Total images to process
  processedImages Int            @default(0)
  detectionsFound Int            @default(0)
  errorMessage    String?

  // Timestamps
  createdAt   DateTime  @default(now())
  startedAt   DateTime?
  completedAt DateTime?

  // Relations
  project            Project             @relation(fields: [projectId], references: [id], onDelete: Cascade)
  pendingAnnotations PendingAnnotation[]

  @@index([projectId])
  @@index([status])
}

enum BatchJobStatus {
  QUEUED
  PROCESSING
  COMPLETED
  FAILED
  CANCELLED
}

model PendingAnnotation {
  id         String @id @default(cuid())
  batchJobId String
  assetId    String
  weedType   String
  confidence Float // SAM3 confidence score
  similarity Float? // Concept similarity score (if available)

  // Coordinates
  polygon Json // [[x,y], ...] pixel coordinates
  bbox    Json // [x1, y1, x2, y2] bounding box

  // Geographic (computed from pixel coords)
  geoPolygon Json? // GeoJSON polygon
  centerLat  Float?
  centerLon  Float?

  // Review status
  status          PendingAnnotationStatus @default(PENDING)
  reviewedAt      DateTime?
  reviewedBy      String?
  rejectionReason String?

  createdAt DateTime @default(now())

  // Relations
  batchJob BatchJob @relation(fields: [batchJobId], references: [id], onDelete: Cascade)
  asset    Asset    @relation(fields: [assetId], references: [id], onDelete: Cascade)

  @@index([batchJobId])
  @@index([assetId])
  @@index([status])
  @@index([weedType])
}

enum PendingAnnotationStatus {
  PENDING
  ACCEPTED
  REJECTED
}

// ============================================
// Unified Review Session Models
// ============================================

model ReviewSession {
  id String @id @default(cuid())

  // Ownership
  teamId       String
  team         Team      @relation(fields: [teamId], references: [id], onDelete: Cascade)
  createdById  String
  createdBy    User      @relation("ReviewSessionCreator", fields: [createdById], references: [id])
  assignedToId String?
  assignedTo   User?     @relation("ReviewSessionAssignee", fields: [assignedToId], references: [id], onDelete: SetNull)
  assignedAt   DateTime?

  // Project scope
  projectId String
  project   Project @relation(fields: [projectId], references: [id], onDelete: Cascade)

  // Workflow context
  workflowType      String
  targetType        String
  roboflowProjectId String?
  yoloModelName     String?

  // Filters (used at creation)
  confidenceThreshold Float?
  weedTypeFilter      String?

  // Asset snapshot (deterministic review/export)
  assetIds   Json // String[] of asset IDs
  assetCount Int

  // Job linkage (app-level defaults)
  inferenceJobIds Json? // String[] of YOLOInferenceJob IDs
  batchJobIds     Json? // String[] of BatchJob IDs

  // Status and counters
  status        String @default("active")
  itemsReviewed Int    @default(0)
  itemsAccepted Int    @default(0)
  itemsRejected Int    @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  edits    ReviewSessionEdit[]
  yoloJobs YOLOInferenceJob[]

  @@index([teamId])
  @@index([projectId])
  @@index([status])
  @@index([assignedToId])
}

model CameraProfile {
  id                    String   @id @default(cuid())
  teamId                String
  name                  String
  description           String?
  fov                   Float?
  calibratedFocalLength Float?
  opticalCenterX        Float?
  opticalCenterY        Float?
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  team     Team      @relation(fields: [teamId], references: [id], onDelete: Cascade)
  projects Project[]
  assets   Asset[]

  @@unique([teamId, name])
  @@index([teamId])
}

model ReviewSessionEdit {
  id              String        @id @default(cuid())
  reviewSessionId String
  reviewSession   ReviewSession @relation(fields: [reviewSessionId], references: [id], onDelete: Cascade)
  sourceType      String
  sourceId        String
  newAnnotationId String
  createdAt       DateTime      @default(now())

  @@unique([reviewSessionId, sourceType, sourceId])
  @@index([reviewSessionId])
}

model YOLOInferenceJob {
  id String @id @default(cuid())

  // Ownership
  teamId      String
  team        Team   @relation(fields: [teamId], references: [id], onDelete: Cascade)
  createdById String
  createdBy   User   @relation(fields: [createdById], references: [id])

  // Context
  reviewSessionId String?
  reviewSession   ReviewSession? @relation(fields: [reviewSessionId], references: [id], onDelete: SetNull)
  projectId       String
  project         Project        @relation(fields: [projectId], references: [id], onDelete: Cascade)
  assetIds        Json? // String[] - only when reviewSessionId is null

  // Model config
  modelName  String
  confidence Float  @default(0.5)

  // Status
  status          BatchJobStatus @default(QUEUED)
  processedImages Int            @default(0)
  totalImages     Int
  detectionsFound Int            @default(0)
  errorMessage    String?

  createdAt   DateTime  @default(now())
  completedAt DateTime?

  detections Detection[]

  @@index([teamId])
  @@index([projectId])
  @@index([reviewSessionId])
  @@index([status])
}

// ============================================
// Roboflow Training Integration Models
// ============================================

model RoboflowProject {
  id          String  @id @default(cuid())
  roboflowId  String  @unique // Roboflow project ID e.g., "lantana-detection-v3"
  workspaceId String // Roboflow workspace name
  name        String // Display name
  type        String // "object-detection" or "instance-segmentation"
  annotation  String? // Annotation group name

  // Cached stats (refreshed on sync)
  imageCount   Int      @default(0)
  lastSyncedAt DateTime @default(now())

  // Relations
  classes          RoboflowClass[]
  trainingSessions TrainingSession[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([roboflowId])
  @@index([workspaceId])
}

model RoboflowClass {
  id        String  @id @default(cuid())
  projectId String
  className String
  color     String? // For UI display consistency
  count     Int     @default(0) // Number of images with this class

  project RoboflowProject @relation(fields: [projectId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([projectId, className])
  @@index([projectId])
  @@index([className])
}

model TrainingSession {
  id                String                @id @default(cuid())
  roboflowProjectId String
  workflowType      TrainingWorkflowType
  status            TrainingSessionStatus @default(IN_PROGRESS)

  // Stats
  imagesTotal        Int @default(0)
  imagesLabeled      Int @default(0)
  annotationsCreated Int @default(0)
  annotationsPushed  Int @default(0)

  // Relations
  roboflowProject RoboflowProject    @relation(fields: [roboflowProjectId], references: [id])
  annotations     ManualAnnotation[]

  createdAt   DateTime  @default(now())
  completedAt DateTime?
  pushedAt    DateTime?

  @@index([roboflowProjectId])
  @@index([status])
}

enum TrainingWorkflowType {
  NEW_SPECIES
  IMPROVE_EXISTING
}

enum TrainingSessionStatus {
  IN_PROGRESS
  READY_TO_PUSH
  PUSHING
  COMPLETED
  FAILED
}

enum DatasetStatus {
  CREATING
  READY
  TRAINING
  FAILED
  ARCHIVED
}

// ============================================
// YOLO Training Pipeline Models
// ============================================

model TrainingDataset {
  id          String  @id @default(cuid())
  name        String
  description String?

  // Version identification
  version     Int?
  displayName String?

  // Snapshot metadata
  snapshotAt DateTime?
  status     DatasetStatus @default(READY)

  // Preprocessing config
  preprocessingConfig Json?

  // S3 location
  s3Path   String
  s3Bucket String

  // Source project (optional - can be built from multiple sessions)
  projectId String?
  project   Project? @relation(fields: [projectId], references: [id])

  // Dataset statistics
  imageCount Int
  labelCount Int
  classes    String // JSON: ["wattle", "lantana", ...]

  // Train/val/test split
  trainCount Int
  valCount   Int
  testCount  Int

  // Augmentation settings applied
  augmentationPreset  String?
  augmentationConfig  String? // JSON
  augmentedImageCount Int?

  // Annotation manifest (S3-based)
  annotationManifestS3Key    String?
  annotationManifestChecksum String?
  annotationCount            Int?

  // Idempotency for safe API calls
  idempotencyKey String? @unique

  // Filters used at creation
  creationFilters Json?

  // Relations
  trainingJobs TrainingJob[]
  assets       TrainingDatasetAsset[]

  // Ownership
  teamId      String
  team        Team    @relation(fields: [teamId], references: [id])
  createdById String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([teamId])
  @@index([projectId])
  @@unique([projectId, version])
}

model TrainingDatasetAsset {
  id        String @id @default(cuid())
  datasetId String
  assetId   String

  // Snapshot of key asset data at freeze time
  s3Key        String?
  gpsLatitude  Float?
  gpsLongitude Float?

  createdAt DateTime @default(now())

  dataset TrainingDataset @relation(fields: [datasetId], references: [id], onDelete: Cascade)
  asset   Asset           @relation(fields: [assetId], references: [id], onDelete: Cascade)

  @@unique([datasetId, assetId])
  @@index([datasetId])
  @@index([assetId])
}

model TrainingJob {
  id String @id @default(cuid())

  // What we're training
  datasetId String
  dataset   TrainingDataset @relation(fields: [datasetId], references: [id])

  // Training configuration
  baseModel    String
  epochs       Int    @default(100)
  batchSize    Int    @default(16)
  imageSize    Int    @default(640)
  learningRate Float  @default(0.01)

  // Advanced config (optional)
  trainingConfig String? // JSON

  // Status tracking
  status       TrainingStatus @default(QUEUED)
  currentEpoch Int            @default(0)
  progress     Float          @default(0)

  // Reference to EC2 job
  ec2JobId String?

  // Metrics - updated during training
  currentMetrics String? // JSON
  metricsHistory String? // JSON

  // Final metrics (populated on completion)
  finalMAP50     Float?
  finalMAP5095   Float?
  finalPrecision Float?
  finalRecall    Float?
  finalF1        Float?

  // Timing
  startedAt        DateTime?
  completedAt      DateTime?
  estimatedMinutes Int?

  // Error handling
  errorMessage String?
  errorDetails String? // JSON

  // Output model (created on successful completion)
  trainedModelId String?       @unique
  trainedModel   TrainedModel? @relation(fields: [trainedModelId], references: [id])

  // Checkpoint training
  checkpointModelId String?
  checkpointModel   TrainedModel? @relation("CheckpointFrom", fields: [checkpointModelId], references: [id])

  // Ownership
  teamId      String
  team        Team    @relation(fields: [teamId], references: [id])
  createdById String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([teamId])
  @@index([status])
  @@index([datasetId])
}

model TrainedModel {
  id String @id @default(cuid())

  // Naming
  name        String
  version     Int
  displayName String?
  description String?

  // S3 storage
  s3Path        String
  s3Bucket      String
  weightsFile   String @default("best.pt")
  fileSizeBytes Int?

  // What this model detects
  classes    String // JSON
  classCount Int

  // Performance metrics
  mAP50     Float?
  mAP5095   Float?
  precision Float?
  recall    Float?
  f1Score   Float?

  // Per-class metrics
  classMetrics String? // JSON

  // Training lineage
  trainingJob     TrainingJob?
  baseModel       String
  trainedOnImages Int?
  trainedEpochs   Int?
  trainedFromThis TrainingJob[] @relation("CheckpointFrom")

  // Detection lineage
  detections Detection[]

  // Status
  status   ModelStatus @default(READY)
  isActive Boolean     @default(false)

  // Usage tracking
  inferenceCount Int       @default(0)
  lastUsedAt     DateTime?

  // Ownership
  teamId      String
  team        Team    @relation(fields: [teamId], references: [id])
  createdById String?

  activeProjects Project[] @relation("ProjectActiveModel")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([name, version, teamId])
  @@index([teamId])
  @@index([status])
  @@index([isActive])
}

enum TrainingStatus {
  QUEUED
  PREPARING
  RUNNING
  UPLOADING
  COMPLETED
  FAILED
  CANCELLED
}

enum ModelStatus {
  TRAINING
  READY
  ACTIVE
  ARCHIVED
  FAILED
}

// ============================================
// Audit Trail for Data Modifications
// ============================================

model AuditLog {
  id String @id @default(cuid())

  // Action details
  action     AuditAction
  entityType String // e.g., "Detection", "ManualAnnotation", "Project"
  entityId   String // ID of the affected entity

  // State tracking (JSON blobs for flexibility)
  beforeState Json? // State before modification
  afterState  Json? // State after modification

  // Actor information
  userId    String? // Who performed the action (null for system actions)
  userEmail String? // Cached for when user is deleted
  ipAddress String? // Request origin
  userAgent String? // Browser/client info

  // Request context
  requestId String? // Correlation ID for tracing

  // Timestamps
  createdAt DateTime @default(now())

  // Indexes for efficient querying
  @@index([userId])
  @@index([entityType, entityId])
  @@index([action])
  @@index([createdAt])
}

enum AuditAction {
  CREATE
  UPDATE
  DELETE
  VERIFY
  UNVERIFY
  REJECT
  PUSH_TO_TRAINING
}
